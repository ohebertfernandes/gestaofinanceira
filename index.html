<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYCASH | App</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://trello.com/1/cards/69839337e9ae9fb5e25dcf21/attachments/69839e6ada37711734777002/download/fycash_logo.png">
    
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: {
                    sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                },
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
                        primary: { DEFAULT: '#8D5AE4', light: '#a78bfa', dark: '#7c3aed' }, // Roxo
                        secondary: { DEFAULT: '#21E9CA', light: '#5eead4', dark: '#0d9488' }, // Ciano
                        brand: {
                            cyan: '#21E9CA',
                            purple: '#8D5AE4',
                            dark: '#0f172a'
                        }
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'enter': 'enter 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        enter: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; -webkit-font-smoothing: antialiased; }
        .dark body { background-color: #0f172a; color: #f1f5f9; }
        .dark .bg-white { background-color: #1e293b; }
        .dark .border-slate-100, .dark .border-slate-200 { border-color: #334155; }
        
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .page-enter { animation: enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        
        .nav-link { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 12px; }
        .nav-link:hover { background-color: #f1f5f9; color: #0f172a; transform: translateX(4px); }
        .dark .nav-link:hover { background-color: #334155; color: #fff; }
        .nav-link.active { background-color: #8D5AE4; color: white; box-shadow: 0 4px 12px rgba(141, 90, 228, 0.3); transform: translateX(4px); }
        .dark .nav-link.active { background-color: #8D5AE4; color: white; }
        .nav-link.active i { color: white; }

        .card { background: white; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 2px 10px rgba(0,0,0,0.02); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .dark .card { background: #1e293b; border-color: #334155; box-shadow: none; }

        button:active { transform: scale(0.95); }
        input, select { transition: all 0.3s ease; }
        input:focus, select:focus { ring: 2px; ring-color: #21E9CA; border-color: transparent; transform: translateY(-1px); }

        .mob-nav-item.active { color: #8D5AE4; transform: scale(1.1); }
        .mob-nav-item.active i { transform: translateY(-2px); }

        .score-circle { width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(var(--score-color) var(--score-deg), rgba(255,255,255,0.1) 0deg); display: flex; align-items: center; justify-content: center; position: relative; transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .score-circle::before { content: ""; position: absolute; width: 80px; height: 80px; border-radius: 50%; background: #1e293b; }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-brand-cyan selection:text-white">

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-50 dark:bg-slate-900 transition-all duration-700">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-brand-purple/20 blur-[100px] animate-blob"></div>
            <div class="absolute top-[40%] -right-[10%] w-[40%] h-[40%] rounded-full bg-brand-cyan/20 blur-[100px] animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-[20%] left-[20%] w-[30%] h-[30%] rounded-full bg-purple-400/20 blur-[100px] animate-blob animation-delay-4000"></div>
        </div>
        
        <div class="glass w-full max-w-md p-8 rounded-3xl relative shadow-2xl mx-4 page-enter">
            <div class="text-center mb-8">
                <!-- NOVA LOGO -->
                <img src="https://trello.com/1/cards/69839337e9ae9fb5e25dcf21/attachments/69839e6ada37711734777002/download/fycash_logo.png" alt="Fycash Logo" class="h-32 w-auto mx-auto mb-2 animate-float object-contain drop-shadow-lg">
                <h1 class="text-3xl font-extrabold text-slate-800 dark:text-white tracking-tight hidden">Fycash.</h1>
                <p class="text-slate-500 dark:text-slate-400 font-medium">Controle financeiro inteligente.</p>
            </div>

            <div id="view-login" class="space-y-6">
                <!-- Formul√°rio de Login -->
                <div class="space-y-4">
                    <div class="relative group">
                        <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand-purple transition-colors"></i>
                        <input type="email" id="log-email" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-purple/50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="E-mail" required>
                    </div>
                    <div class="relative group">
                        <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand-purple transition-colors"></i>
                        <input type="password" id="log-pass" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-purple/50 dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="Senha" required>
                    </div>
                </div>
                <!-- Bot√£o de Login (Purple) -->
                <button id="login-visible-btn" onclick="document.getElementById('form-login-btn').click()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition shadow-lg dark:bg-brand-purple dark:hover:bg-purple-700 active:scale-95 disabled:opacity-50 disabled:cursor-wait">
                    Entrar na Conta
                </button>
                <button id="form-login-btn" class="hidden" onclick="handleLogin()"></button>

                <!-- Separador -->
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200 dark:border-slate-700"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-medium">OU</span>
                    <div class="flex-grow border-t border-slate-200 dark:border-slate-700"></div>
                </div>

                <!-- Bot√£o Acessar sem Conta -->
                <button onclick="forceOfflineMode()" class="w-full bg-white border border-slate-200 text-slate-600 font-bold py-3.5 rounded-xl hover:bg-slate-50 transition active:scale-95 flex items-center justify-center gap-2 dark:bg-slate-800 dark:border-slate-700 dark:text-white hover:border-brand-cyan/30">
                    <i class="fa-solid fa-user-secret"></i> Acessar sem Conta
                </button>
                
                <p class="text-center text-[10px] text-slate-400">
                    <i class="fa-solid fa-info-circle"></i> O modo sem conta n√£o armazena dados na nuvem.
                </p>
            </div>
            
            <p id="auth-error" class="text-red-500 text-xs mt-3 font-bold h-4 text-center"></p>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-screen" class="hidden w-full h-full opacity-0 transition-opacity duration-500">
        
        <!-- SIDEBAR (Desktop) -->
        <aside class="hidden md:flex flex-col w-72 bg-white border-r border-slate-200 h-full z-20 dark:bg-slate-900 dark:border-slate-800">
            <div class="p-6 flex items-center justify-center">
                <!-- Logo Sidebar -->
                <img src="https://trello.com/1/cards/69839337e9ae9fb5e25dcf21/attachments/69839e6ada37711734777002/download/fycash_logo.png" alt="Fycash Logo" class="h-16 w-auto object-contain animate-float">
            </div>

            <div class="px-4 py-2">
                <div class="bg-slate-50 border border-slate-100 rounded-xl p-3 flex items-center gap-3 dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-100 transition cursor-pointer">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xs font-bold dark:bg-slate-700 dark:text-slate-300 user-avatar-initials">U</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-slate-800 truncate dark:text-white" id="user-name-display">Usu√°rio</p>
                        <p class="text-[10px] text-slate-400 truncate" id="user-plan-display">Plano Pro</p>
                    </div>
                    <button onclick="openAdmin()" id="btn-admin" class="hidden text-xs text-slate-400 hover:text-brand-cyan"><i class="fa-solid fa-lock"></i></button>
                </div>
            </div>

            <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto custom-scrollbar">
                <button onclick="nav('dashboard')" id="nav-d-dashboard" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-chart-pie w-5 text-center transition-colors"></i> Dashboard
                </button>
                <button onclick="nav('launch')" id="nav-d-launch" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-plus-circle w-5 text-center transition-colors"></i> Lan√ßamentos
                </button>
                <button onclick="nav('dre')" id="nav-d-dre" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-file-invoice-dollar w-5 text-center transition-colors"></i> Relat√≥rio DRE
                </button>
                
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Planejamento</div>
                
                <button onclick="nav('budget')" id="nav-d-budget" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-wallet w-5 text-center transition-colors"></i> Or√ßamento
                </button>
                <button onclick="nav('goals')" id="nav-d-goals" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-bullseye w-5 text-center transition-colors"></i> Metas
                </button>
                <button onclick="nav('fixed')" id="nav-d-fixed" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-receipt w-5 text-center transition-colors"></i> Fixas
                </button>
                <button onclick="nav('debts')" id="nav-d-debts" class="nav-link w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500">
                    <i class="fa-solid fa-landmark w-5 text-center transition-colors"></i> D√≠vidas
                </button>
            </nav>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800 space-y-2">
                <button onclick="openFeedback()" class="w-full flex items-center gap-3 px-4 py-2 text-xs font-bold text-slate-500 hover:text-slate-800 transition rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 dark:hover:text-white">
                    <i class="fa-solid fa-lightbulb w-5"></i> Feedback
                </button>
                <button onclick="toggleTheme()" class="w-full flex items-center gap-3 px-4 py-2 text-xs font-bold text-slate-500 hover:text-slate-800 transition rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 dark:hover:text-white">
                    <i class="fa-solid fa-moon w-5"></i> Tema
                </button>
                <button onclick="doLogout()" class="w-full flex items-center gap-3 px-4 py-2 text-xs font-bold text-red-500 hover:text-red-700 transition rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                    <i class="fa-solid fa-right-from-bracket w-5"></i> Sair
                </button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <!-- Mobile Header -->
            <header class="md:hidden bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center z-20 dark:bg-slate-900/80 dark:border-slate-800">
                <div class="flex items-center gap-2">
                    <!-- Logo Mobile -->
                    <img src="https://trello.com/1/cards/69839337e9ae9fb5e25dcf21/attachments/69839e6ada37711734777002/download/fycash_logo.png" alt="Fycash Logo" class="h-8 w-auto object-contain">
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openWhatsAppModal()" class="w-9 h-9 rounded-full bg-green-500 text-white shadow-lg shadow-green-500/30 flex items-center justify-center active:scale-95 transition"><i class="fa-solid fa-microphone"></i></button>
                    <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300 flex items-center justify-center active:scale-95 transition"><i class="fa-solid fa-moon"></i></button>
                </div>
            </header>

            <!-- Main Scrollable -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="main-content">
                <div class="max-w-6xl mx-auto pb-24 md:pb-0">
                    
                    <!-- Desktop Header Action -->
                    <div class="hidden md:flex justify-between items-center mb-8 page-enter">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800 dark:text-white" id="page-title">Vis√£o Geral</h1>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Bem-vindo de volta ao seu controle financeiro.</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openWhatsAppModal()" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg shadow-green-600/20 transition font-bold text-sm hover:-translate-y-1">
                                <i class="fa-solid fa-microphone"></i> IA Voice
                            </button>
                            <button onclick="nav('launch')" class="flex items-center gap-2 px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white rounded-xl shadow-lg shadow-slate-900/20 transition font-bold text-sm dark:bg-brand-purple dark:hover:bg-purple-700 hover:-translate-y-1">
                                <i class="fa-solid fa-plus"></i> Novo Lan√ßamento
                            </button>
                        </div>
                    </div>

                    <!-- PAGES -->
                    <!-- 1. DASHBOARD -->
                    <div id="page-dashboard" class="space-y-6">
                        <!-- Score & Stats -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Score Card -->
                            <div class="card p-6 relative overflow-hidden bg-gradient-to-br from-slate-900 to-slate-800 text-white border-0 page-enter">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-brand-purple/20 blur-[50px] rounded-full animate-pulse"></div>
                                <div class="relative z-10 flex justify-between items-start">
                                    <div>
                                        <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Score Financeiro</p>
                                        <h2 class="text-4xl font-extrabold tracking-tight" id="score-val">--</h2>
                                        <p class="text-xs text-slate-400 mt-2 max-w-[150px]" id="score-msg">Calculando...</p>
                                        <div id="score-alert-box" class="hidden bg-red-500/20 border border-red-500/30 rounded-lg p-2 mt-2">
                                            <p class="text-[10px] text-red-200" id="score-action-plan">...</p>
                                        </div>
                                    </div>
                                    <div class="score-circle" id="score-circle" style="--score-color: #8D5AE4; --score-deg: 0deg;">
                                        <i class="fa-solid fa-shield-halved text-2xl text-brand-purple z-10"></i>
                                    </div>
                                </div>
                                <div class="mt-6 flex gap-2">
                                    <button onclick="openArcaModal()" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-bold backdrop-blur-sm transition hover:scale-105">Metodologia ARCA</button>
                                </div>
                            </div>

                            <!-- Balance & Summary -->
                            <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="card p-5 flex flex-col justify-between page-enter delay-100">
                                    <div class="w-10 h-10 rounded-xl bg-green-50 text-green-600 flex items-center justify-center mb-2 dark:bg-green-900/20 dark:text-green-400"><i class="fa-solid fa-arrow-up"></i></div>
                                    <div><p class="text-xs text-slate-500 font-bold uppercase">Entradas</p><p class="text-lg font-bold text-slate-800 dark:text-white" id="dash-income">R$ 0</p></div>
                                </div>
                                <div class="card p-5 flex flex-col justify-between page-enter delay-200">
                                    <div class="w-10 h-10 rounded-xl bg-red-50 text-red-600 flex items-center justify-center mb-2 dark:bg-red-900/20 dark:text-red-400"><i class="fa-solid fa-arrow-down"></i></div>
                                    <div><p class="text-xs text-slate-500 font-bold uppercase">Sa√≠das</p><p class="text-lg font-bold text-slate-800 dark:text-white" id="dash-expense">R$ 0</p></div>
                                </div>
                                <div class="card p-5 flex flex-col justify-between page-enter delay-300">
                                    <div class="w-10 h-10 rounded-xl bg-brand-purple text-white flex items-center justify-center mb-2 dark:bg-purple-900/20 dark:text-purple-400"><i class="fa-solid fa-piggy-bank"></i></div>
                                    <div><p class="text-xs text-slate-500 font-bold uppercase">Investido</p><p class="text-lg font-bold text-slate-800 dark:text-white" id="dash-invest">R$ 0</p></div>
                                </div>
                                <div class="card p-5 flex flex-col justify-between border-brand-cyan/20 bg-brand-cyan/5 dark:bg-cyan-900/10 page-enter delay-300">
                                    <div class="w-10 h-10 rounded-xl bg-brand-cyan text-white flex items-center justify-center mb-2 shadow-lg shadow-cyan-500/30"><i class="fa-solid fa-wallet"></i></div>
                                    <div><p class="text-xs text-brand-cyan font-bold uppercase">Saldo Atual</p><p class="text-lg font-bold text-brand-cyan dark:text-cyan-300" id="dash-balance">R$ 0</p></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rest of Dashboard (Charts) -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="card p-6 page-enter delay-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-slate-800 dark:text-white">Receita vs Despesas</h3>
                                </div>
                                <div class="h-64 relative"><canvas id="chart-expenses"></canvas></div>
                            </div>
                            <div class="card p-6 page-enter delay-200">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-slate-800 dark:text-white">Gastos por Categoria</h3>
                                </div>
                                <div class="h-64 relative flex items-center justify-center"><canvas id="chart-pie-expenses"></canvas></div>
                            </div>
                            <div id="bottleneck-chart-container" class="hidden card p-6 col-span-2 border-red-200 bg-red-50 dark:bg-red-900/10 page-enter">
                                <h3 class="font-bold text-red-700 dark:text-red-400 mb-4 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Categorias Acima do Or√ßamento</h3>
                                <div class="h-48 w-full"><canvas id="chart-bottlenecks"></canvas></div>
                            </div>
                        </div>

                        <!-- Quick Goals -->
                        <div class="card p-6 bg-gradient-to-r from-brand-purple to-purple-800 text-white border-0 shadow-lg shadow-purple-500/20 relative overflow-hidden page-enter delay-100">
                            <div class="relative z-10 flex justify-between items-end">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-white/20 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold uppercase">Meta em Foco</span>
                                        <div class="flex gap-1 ml-2">
                                            <button onclick="prevGoal()" class="w-6 h-6 bg-white/10 hover:bg-white/20 rounded flex items-center justify-center transition hover:scale-110"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                                            <button onclick="nextGoal()" class="w-6 h-6 bg-white/10 hover:bg-white/20 rounded flex items-center justify-center transition hover:scale-110"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                                        </div>
                                    </div>
                                    <h3 class="text-2xl font-bold mb-1" id="dash-goal-name">Sem Metas</h3>
                                    <p class="text-purple-100 text-sm">Faltam <span class="font-bold text-white" id="dash-goal-missing">R$ 0,00</span></p>
                                    <p class="text-[10px] text-white/70 mt-1" id="dash-goal-monthly">--</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-3xl font-bold" id="dash-goal-pct">0%</span>
                                </div>
                            </div>
                            <div class="w-full bg-black/20 h-2 mt-4 rounded-full overflow-hidden">
                                <div id="dash-goal-bar" class="bg-white h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. LAN√áAMENTOS -->
                    <div id="page-launch" class="hidden space-y-6">
                        <!-- ... (Rest of Launch Page as before) ... -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-1 space-y-6 page-enter">
                                <div class="card p-6">
                                    <h3 class="text-lg font-bold text-slate-800 mb-4 dark:text-white">Novo Registro</h3>
                                    <div class="flex p-1 bg-slate-100 rounded-xl mb-6 dark:bg-slate-800">
                                        <button onclick="setLaunchMode('expense')" id="btn-mode-exp" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-slate-800 shadow-sm transform border-brand-purple">Despesa</button>
                                        <button onclick="setLaunchMode('income')" id="btn-mode-inc" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-slate-700">Receita</button>
                                    </div>
                                    <form id="form-expense" onsubmit="addVar(event)" class="space-y-4">
                                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Valor</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">R$</span><input id="var-val" type="number" step="0.01" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg text-slate-800 outline-none focus:ring-2 focus:ring-red-500/50 dark:bg-slate-900 dark:border-slate-700 dark:text-white" placeholder="0,00" required></div></div>
                                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Descri√ß√£o</label><input id="var-desc" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-brand-purple/50 dark:bg-slate-900 dark:border-slate-700 dark:text-white" placeholder="Ex: Uber, Mercado..." required></div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div><label class="text-[10px] font-bold text-slate-400 uppercase">Categoria</label><select id="var-cat" onchange="handleCatChange(this)" class="w-full px-3 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none dark:bg-slate-900 dark:border-slate-700 dark:text-white"></select></div>
                                            <div><label class="text-[10px] font-bold text-slate-400 uppercase">Data</label><input type="date" id="var-date" class="w-full px-3 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none dark:bg-slate-900 dark:border-slate-700 dark:text-white" required></div>
                                        </div>
                                        <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100 dark:bg-slate-900 dark:border-slate-800"><span class="text-xs font-bold text-slate-500 uppercase">Parcelas</span><input id="var-parc" type="number" min="1" max="48" value="1" class="w-16 px-2 py-1 text-center font-bold bg-white border border-slate-200 rounded-lg text-sm dark:bg-slate-800 dark:border-slate-700"></div>
                                        <button id="btn-save-exp" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-500/20 transition hover:-translate-y-1">Confirmar Sa√≠da</button>
                                    </form>
                                    <form id="form-income" onsubmit="addIncome(event)" class="space-y-4 hidden">
                                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Valor</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">R$</span><input id="inc-val" type="number" step="0.01" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg text-green-600 outline-none focus:ring-2 focus:ring-green-500/50 dark:bg-slate-900 dark:border-slate-700" placeholder="0,00" required></div></div>
                                        <input id="inc-desc" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none dark:bg-slate-900 dark:border-slate-700" placeholder="Descri√ß√£o" required>
                                        <input list="origins-list" id="inc-origin" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none dark:bg-slate-900 dark:border-slate-700" placeholder="Origem (Ex: Sal√°rio)">
                                        <datalist id="origins-list"></datalist>
                                        <input type="date" id="inc-date" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none dark:bg-slate-900 dark:border-slate-700" required>
                                        <button id="btn-save-inc" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-500/20 transition hover:-translate-y-1">Confirmar Entrada</button>
                                    </form>
                                </div>
                            </div>
                            <div class="md:col-span-2 card p-6 flex flex-col h-[600px] page-enter delay-100">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800 dark:text-white">√öltimas Movimenta√ß√µes</h3><div class="flex gap-2"><label class="cursor-pointer p-2 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-brand-purple transition dark:hover:bg-slate-800" title="Importar CSV"><i class="fa-solid fa-file-import"></i><input type="file" class="hidden" accept=".csv" onchange="importCSV(this)"></label></div></div>
                                <div id="pending-section" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-xl flex items-center justify-between dark:bg-yellow-900/20 dark:border-yellow-800 animate-pulse"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center font-bold text-xs"><i class="fa-solid fa-exclamation"></i></div><span class="text-sm font-bold text-yellow-800 dark:text-yellow-200">Itens Pendentes</span></div><i class="fa-solid fa-chevron-down text-yellow-400"></i></div>
                                <ul id="list-pending" class="mb-4 space-y-2"></ul>
                                <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar"><table class="w-full text-left border-collapse"><thead class="sticky top-0 bg-white z-10 dark:bg-slate-900"><tr><th class="py-3 text-[10px] uppercase font-bold text-slate-400 border-b border-slate-100 dark:border-slate-800">Data</th><th class="py-3 text-[10px] uppercase font-bold text-slate-400 border-b border-slate-100 dark:border-slate-800">Desc</th><th class="py-3 text-[10px] uppercase font-bold text-slate-400 border-b border-slate-100 dark:border-slate-800">Cat</th><th class="py-3 text-[10px] uppercase font-bold text-slate-400 border-b border-slate-100 text-right dark:border-slate-800">Valor</th><th class="py-3 border-b border-slate-100 dark:border-slate-800"></th></tr></thead><tbody id="list-all-transactions" class="text-sm"></tbody></table></div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. DRE -->
                    <div id="page-dre" class="hidden space-y-6">
                         <div class="card p-8 page-enter">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6 dark:text-white border-l-4 border-brand-purple pl-4">Demonstrativo de Resultados</h2>
                            <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold dark:bg-slate-800 dark:text-slate-400"><tr><th class="p-4 text-left rounded-l-lg">Conta</th><th class="p-4 text-right">Valor</th><th class="p-4 text-right rounded-r-lg w-24">%</th></tr></thead><tbody id="dre-body" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table></div>
                            <div class="mt-6 flex justify-end"><div class="bg-slate-900 text-white px-6 py-4 rounded-xl flex items-center gap-6 shadow-xl dark:bg-slate-950 hover:scale-105 transition"><span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Lucro L√≠quido</span><span class="text-2xl font-bold" id="dre-net-profit">R$ 0,00</span></div></div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="card p-6 page-enter delay-100"><h4 class="font-bold mb-4">Tend√™ncia</h4><div class="h-48 relative"><canvas id="chart-dre-trend"></canvas></div></div>
                            <div class="card p-6 page-enter delay-200"><h4 class="font-bold mb-4">Composi√ß√£o</h4><div class="h-48 relative"><canvas id="chart-dre-comp"></canvas></div></div>
                        </div>
                    </div>

                    <!-- 4. OR√áAMENTO -->
                    <div id="page-budget" class="hidden">
                         <div class="card p-6 mb-6 page-enter">
                            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold dark:text-white">Or√ßamento</h2><div class="flex gap-2"><button onclick="applyBudgetMethod('PADRAO')" class="px-3 py-1 bg-slate-100 rounded text-xs font-bold hover:bg-slate-200 transition">Padr√£o 50/30/20</button><button onclick="applyBudgetMethod('WAR')" class="px-3 py-1 bg-slate-100 rounded text-xs font-bold hover:bg-slate-200 transition">Modo Guerra</button></div></div>
                            <div id="budget-list" class="grid md:grid-cols-2 gap-4"></div>
                        </div>
                        <div class="card p-6 page-enter delay-100">
                            <h3 class="font-bold mb-4">Gerenciar Categorias</h3>
                            <ul id="category-list-manage" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></ul>
                            <div class="flex gap-2"><input id="new-cat-input" class="border p-2 rounded flex-1 dark:bg-slate-900 dark:border-slate-700" placeholder="Nova Categoria"><button onclick="addNewCategory()" class="bg-brand-cyan text-slate-900 px-4 rounded font-bold hover:bg-cyan-300 transition">Add</button></div>
                        </div>
                    </div>

                    <!-- 5. METAS -->
                    <div id="page-goals" class="hidden space-y-6">
                        <!-- ... (Same as previous) ... -->
                        <div class="card p-6 page-enter">
                            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold dark:text-white">Metas</h2><button onclick="askAI('goals')" class="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded font-bold hover:bg-purple-200 transition">Consultar IA</button></div>
                            <form onsubmit="addGoal(event)" class="flex gap-3 mb-6"><input id="goal-name" placeholder="Nome" class="flex-[2] p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700" required><input id="goal-val" type="number" placeholder="Valor" class="flex-1 p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700" required><input id="goal-date" type="date" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700" required><button class="bg-brand-purple text-white px-6 rounded-xl font-bold hover:bg-purple-700 transition">Criar</button></form>
                            <div id="list-goals-full" class="grid md:grid-cols-2 gap-4"></div>
                        </div>
                        <div class="card p-6 border-l-4 border-l-brand-purple page-enter delay-100">
                            <h2 class="font-bold text-lg mb-4 text-brand-purple">Calculadora de Juros Compostos</h2>
                            <div class="grid md:grid-cols-4 gap-4 mb-4"><input id="comp-initial" type="number" placeholder="Inicial" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700"><input id="comp-monthly" type="number" placeholder="Aporte/m√™s" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700"><input id="comp-rate" type="number" placeholder="Taxa % a.a." class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700"><input id="comp-years" type="number" placeholder="Anos" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700"></div>
                            <button onclick="simulateCompoundInterest()" class="w-full bg-brand-purple text-white font-bold py-3 rounded-xl hover:bg-purple-700 transition mb-6 hover:shadow-lg">Simular Futuro</button>
                            <div id="comp-result-area" class="hidden"><div class="grid md:grid-cols-3 gap-4 mb-6 text-center"><div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-800"><p class="text-xs uppercase text-slate-400 font-bold">Total</p><p class="text-xl font-bold text-brand-purple" id="comp-result-total">R$ 0</p></div><div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-800"><p class="text-xs uppercase text-slate-400 font-bold">Investido</p><p class="text-lg font-bold" id="comp-result-invested">R$ 0</p></div><div class="bg-slate-50 p-4 rounded-xl dark:bg-slate-800"><p class="text-xs uppercase text-slate-400 font-bold">Juros</p><p class="text-lg font-bold text-green-500" id="comp-result-interest">R$ 0</p></div></div><div class="h-64 relative"><canvas id="chart-compound"></canvas></div></div>
                        </div>
                    </div>

                    <!-- 6. D√çVIDAS & FIXAS -->
                    <div id="page-debts" class="hidden">
                        <div class="card p-6 border-l-4 border-l-red-500 page-enter">
                            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold dark:text-white">D√≠vidas</h2><div class="flex gap-2"><button onclick="simulateDebtStrategy('snowball')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200 transition">Bola de Neve</button><button onclick="simulateDebtStrategy('avalanche')" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200 transition">Avalanche</button></div></div>
                            <form onsubmit="addDebt(event)" class="grid md:grid-cols-5 gap-3 mb-6"><input id="debt-name" placeholder="Nome" class="md:col-span-2 p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700" required><input id="debt-tot" type="number" placeholder="Total" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700" required><input id="debt-rate" type="number" placeholder="Juros %" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700"><input id="debt-inst" type="number" placeholder="Parcelas" class="p-3 border rounded-xl dark:bg-slate-900 dark:border-slate-700" required><button class="bg-red-500 text-white font-bold rounded-xl md:col-span-5 py-3 hover:bg-red-600 transition">Adicionar</button></form>
                            <div id="list-debts" class="space-y-3"></div>
                        </div>
                    </div>
                     <div id="page-fixed" class="hidden">
                        <div class="card p-6 page-enter">
                            <h2 class="text-xl font-bold mb-4 dark:text-white">Custos Fixos</h2>
                            <form onsubmit="addFixed(event)" class="flex gap-2 mb-6"><input id="fix-name" placeholder="Nome (Ex: Aluguel)" class="p-3 border rounded-xl w-full dark:bg-slate-900 dark:border-slate-700" required><input id="fix-val" type="number" placeholder="Valor" class="p-3 border rounded-xl w-32 dark:bg-slate-900 dark:border-slate-700" required><button class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700 transition">Salvar</button></form>
                            <table class="w-full text-left text-sm"><thead class="bg-slate-50 dark:bg-slate-800"><tr><th class="p-3">Nome</th><th class="p-3 text-right">Valor</th><th class="w-10"></th></tr></thead><tbody id="list-fixed" class="divide-y dark:divide-slate-700"></tbody></table>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Mobile Bottom Nav -->
            <nav class="md:hidden bg-white border-t border-slate-200 px-6 py-3 flex justify-between items-center z-30 pb-safe dark:bg-slate-900 dark:border-slate-800">
                <button onclick="nav('dashboard')" id="mob-dashboard" class="mob-nav-item active flex flex-col items-center text-slate-400 text-[10px] font-bold gap-1 transition"><i class="fa-solid fa-chart-pie text-xl"></i> Geral</button>
                <button onclick="nav('launch')" id="mob-launch" class="mob-nav-item flex flex-col items-center text-slate-400 text-[10px] font-bold gap-1 transition"><i class="fa-solid fa-plus-circle text-xl"></i> Add</button>
                <button onclick="nav('dre')" id="mob-dre" class="mob-nav-item flex flex-col items-center text-slate-400 text-[10px] font-bold gap-1 transition"><i class="fa-solid fa-file-invoice text-xl"></i> DRE</button>
                <button onclick="nav('budget')" id="mob-budget" class="mob-nav-item flex flex-col items-center text-slate-400 text-[10px] font-bold gap-1 transition"><i class="fa-solid fa-wallet text-xl"></i> Or√ß</button>
            </nav>
        </div>
    </div>

    <!-- MODALS (Mantidos) -->
    <!-- ... WhatsApp, Edit, Aporte, Arca, Feedback, Admin, AI Modals ... -->
    <div id="whatsapp-modal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden dark:bg-slate-800 border border-slate-200 dark:border-slate-700 animate-enter"><div class="bg-[#075e54] p-4 text-white flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-teal-800"><i class="fa-solid fa-robot"></i></div><div><span class="font-bold block text-sm">Fycash AI</span><span class="text-[10px] opacity-80">Online</span></div></div><button onclick="closeWhatsAppModal()"><i class="fa-solid fa-times"></i></button></div><div class="h-80 bg-[#efe7dd] p-4 overflow-y-auto flex flex-col gap-2" id="whatsapp-chat-area"><div class="self-start bg-white p-2 rounded-lg rounded-tl-none shadow-sm text-sm max-w-[80%]">Ol√°! Sou sua IA financeira. ü§ñ<br>Diga algo como: <i>"Gastei 50 no almo√ßo"</i>.</div></div><div class="p-2 bg-white dark:bg-slate-800 flex gap-2"><input id="ai-input-text" class="flex-1 bg-slate-100 dark:bg-slate-900 rounded-full px-4 py-2 text-sm outline-none border border-transparent focus:border-teal-500" placeholder="Digite..." onkeypress="if(event.key==='Enter') sendAIMessage()"><button onclick="sendAIMessage()" class="w-10 h-10 rounded-full bg-[#075e54] text-white flex items-center justify-center hover:scale-105 transition"><i class="fa-solid fa-paper-plane"></i></button></div></div></div>
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6 dark:bg-slate-800 shadow-2xl animate-enter"><h3 class="font-bold mb-4 dark:text-white text-lg">Classificar Gasto</h3><input type="hidden" id="edit-index"><input id="edit-name" class="w-full p-3 bg-slate-50 rounded-xl mb-3 text-slate-500 text-sm border border-slate-100" readonly><select id="edit-cat" class="w-full p-3 border rounded-xl mb-6 dark:bg-slate-900 dark:border-slate-700 outline-none focus:ring-2 focus:ring-brand-purple"></select><div class="flex justify-end gap-2"><button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition">Cancelar</button><button onclick="confirmEditCat()" class="bg-brand-purple text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-500/30">Salvar</button></div></div></div>
    <div id="aporte-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6 dark:bg-slate-800 shadow-2xl animate-enter"><h3 class="font-bold mb-4 dark:text-white text-lg">Realizar Aporte</h3><input id="aporte-val" type="number" class="w-full p-4 text-2xl font-bold text-center border rounded-xl mb-6 dark:bg-slate-900 dark:border-slate-700 outline-none focus:border-brand-purple text-brand-purple" placeholder="R$ 0,00"><div class="flex justify-end gap-2"><button onclick="document.getElementById('aporte-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancelar</button><button onclick="confirmAporte()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-green-700">Confirmar</button></div></div></div>
    <div id="arca-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-lg rounded-2xl p-6 dark:bg-slate-800 shadow-2xl relative animate-enter"><button onclick="document.getElementById('arca-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button><h3 class="font-bold mb-6 dark:text-white text-lg flex items-center gap-2"><i class="fa-solid fa-chart-pie text-brand-purple"></i> Metodologia ARCA</h3><div class="h-64 mb-4"><canvas id="chart-arca"></canvas></div><p class="text-xs text-center text-slate-400">Comparativo: Sua Carteira vs. Modelo Ideal (Primo Rico)</p></div></div>
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-md rounded-2xl p-6 dark:bg-slate-800 animate-enter"><h3 class="font-bold mb-4 dark:text-white">Enviar Feedback</h3><select id="feedback-type" class="w-full p-2 border rounded mb-2 dark:bg-slate-900"><option value="Melhoria">Sugest√£o</option><option value="Bug">Erro</option></select><textarea id="feedback-text" class="w-full p-3 border rounded h-32 mb-4 dark:bg-slate-900" placeholder="Descreva..."></textarea><div class="flex justify-end gap-2"><button onclick="document.getElementById('feedback-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500">Cancelar</button><button onclick="sendFeedback()" class="bg-brand-purple text-white px-4 py-2 rounded font-bold hover:bg-purple-700 transition">Enviar</button></div></div></div>
    <div id="admin-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-4xl rounded-2xl p-6 dark:bg-slate-800 h-[80vh] flex flex-col animate-enter"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg dark:text-white">Painel Admin</h3><button onclick="document.getElementById('admin-modal').classList.add('hidden')">x</button></div><div class="flex gap-2 mb-4"><button onclick="switchAdminTab('pending')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded font-bold">Pendentes</button><button onclick="switchAdminTab('done')" class="px-3 py-1 bg-slate-100 text-slate-500 rounded font-bold">Conclu√≠dos</button></div><div id="admin-list" class="flex-1 overflow-y-auto bg-slate-50 p-4 rounded dark:bg-slate-900"></div></div></div>
    <div id="ai-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-lg rounded-2xl p-6 dark:bg-slate-800 max-h-[80vh] overflow-y-auto animate-enter"><div class="flex justify-between mb-4 border-b pb-2"><span class="font-bold text-brand-purple">Consultoria IA</span><button onclick="document.getElementById('ai-modal').classList.add('hidden')">x</button></div><div id="ai-content" class="prose text-sm dark:prose-invert"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, orderBy, query, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG (MANUAL RESTORE)
        const ADMIN_EMAIL = "ohebertgustavo@gmail.com";
        const firebaseConfig = {
          apiKey: "AIzaSyCL6XpBIm322dq2hW7z-Y5Nskxdn-T9OzU",
          authDomain: "fluxocash-b81f6.firebaseapp.com",
          projectId: "fluxocash-b81f6",
          storageBucket: "fluxocash-b81f6.firebasestorage.app",
          messagingSenderId: "1021395240266",
          appId: "1:1021395240266:web:e44282819a1ab0c2feadb3"
        };
        const appId = firebaseConfig.appId; 
        const apiKey = ""; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // REMOVED AUTO-AUTH TO FIX CONFLICT

        const DEFAULT_CATEGORIES = ['Moradia', 'Alimenta√ß√£o', 'Transporte', 'Sa√∫de e Cuidados', 'Educa√ß√£o', 'Lazer', 'Investimentos'];

        let currentUser = null;
        let unsubscribeUser = null;
        let appData = { incomes: [], incomeOrigins: [], fixed: [], variable: [], debts: [], goals: [], budgets: [], categories: [] };
        let isOffline = false;
        let chartRev, chartExp, chartBal, chartPie, chartDREComp, chartDRETrend, chartARCA, compoundChart, chartBottle;
        let currentGoalIndex = 0;
        let currentGoalId = null;
        let currentAdminTab = 'pending';

        function fmt(n) { return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(n); }
        
        function checkMigration() { 
            if(!appData.incomes) appData.incomes = []; 
            if(!appData.fixed) appData.fixed = []; 
            if(!appData.variable) appData.variable = []; 
            if(!appData.debts) appData.debts = []; 
            if(!appData.goals) appData.goals = []; 
            if(!appData.budgets) appData.budgets = [];
            if(!appData.incomeOrigins) appData.incomeOrigins = ['Sal√°rio', 'Freelance'];
            if(!appData.categories || appData.categories.length === 0) appData.categories = [...DEFAULT_CATEGORIES];
        }

        async function saveData() { 
            if(isOffline){ localStorage.setItem('fluxocash_local',JSON.stringify(appData)); return; } 
            if(currentUser) await setDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'app_data','main'),appData); 
        }

        function getMonthlyData() {
            const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            const currentYear = new Date().getFullYear();
            const data = Array(12).fill(0).map((_, i) => ({ month: i, revenue: 0, expenses: 0, balance: 0, accumulated: 0 }));
            
            appData.incomes.forEach(inc => { const d = new Date(inc.date + 'T00:00:00'); if(d.getFullYear()===currentYear) data[d.getMonth()].revenue += inc.value; });
            const fixedTotal = appData.fixed.reduce((a,b)=>a+b.value,0);
            data.forEach(d => d.expenses += fixedTotal);
            appData.variable.forEach(v => { const d = new Date(v.date + 'T00:00:00'); if(d.getFullYear()===currentYear) data[d.getMonth()].expenses += v.value; });
            
            let acc = 0; data.forEach(d => { d.balance = d.revenue - d.expenses; acc += d.balance; d.accumulated = acc; });
            return data;
        }

        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }

        function render() {
            const mData = getMonthlyData();
            const curr = mData[new Date().getMonth()];
            
            setText('dash-income', fmt(curr.revenue));
            setText('dash-expense', fmt(curr.expenses));
            setText('dash-balance', fmt(curr.accumulated));
            
            const investments = appData.variable.filter(v => v.category === 'Investimentos').reduce((a,b)=>a+b.value,0);
            setText('dash-invest', fmt(investments));

            let score = 500;
            let action = "Continue assim!";
            if(curr.balance > 0) score += 300; else { score -= 100; action = "Gasto > Ganho. Corte custos."; }
            if(investments > 0) score += 200; else { score -= 50; action = "Comece a investir."; }
            if(appData.debts.length > 0) { score -= (appData.debts.length * 50); if(score<400) action = "Foque em quitar d√≠vidas."; }
            
            score = Math.max(0, Math.min(1000, score));
            const scoreEl = document.getElementById('score-val');
            if(scoreEl) {
                let currentScore = parseInt(scoreEl.innerText) || 0;
                const diff = score - currentScore;
                if(diff !== 0) {
                    const step = diff > 0 ? 5 : -5;
                    const interval = setInterval(() => {
                        currentScore += step;
                        if((step > 0 && currentScore >= score) || (step < 0 && currentScore <= score)) {
                            currentScore = score;
                            clearInterval(interval);
                        }
                        if(scoreEl) scoreEl.innerText = currentScore;
                    }, 10);
                } else {
                    scoreEl.innerText = score;
                }
            }

            setText('score-msg', score > 700 ? "Sa√∫de Excelente!" : "Aten√ß√£o.");
            
            const alertBox = document.getElementById('score-alert-box');
            if(alertBox) {
                if(score < 500) { alertBox.classList.remove('hidden'); setText('score-action-plan', action); }
                else alertBox.classList.add('hidden');
            }

            const circle = document.getElementById('score-circle');
            if(circle) {
                const deg = (score / 1000) * 360;
                const color = score > 700 ? '#21E9CA' : (score > 400 ? '#f59e0b' : '#ef4444');
                circle.style.setProperty('--score-deg', `${deg}deg`);
                circle.style.setProperty('--score-color', color);
            }

            const g = appData.goals[currentGoalIndex];
            if(g) {
                setText('dash-goal-name', g.name);
                const saved = g.saved || 0;
                const remaining = g.totalValue - saved;
                const pct = g.totalValue > 0 ? (saved / g.totalValue) * 100 : 0;
                setText('dash-goal-pct', pct.toFixed(0) + '%');
                const bar = document.getElementById('dash-goal-bar');
                if(bar) bar.style.width = Math.min(pct,100) + '%';
                setText('dash-goal-missing', fmt(remaining));
            } else {
                setText('dash-goal-name', "Sem Metas");
                setText('dash-goal-missing', "--");
                setText('dash-goal-pct', "0%");
                 const bar = document.getElementById('dash-goal-bar');
                if(bar) bar.style.width = '0%';
            }

            renderTransactionsList();
            renderGoalsList();
            renderBudgetList();
            renderFixedList();
            renderDebtsList();
            renderCategoryManagementList();
            renderCharts(mData);
            updateSelects();
        }

        // ... (Render Lists Functions - same logic, compact for file size) ...
        function renderTransactionsList() {
            const lVar = document.getElementById('list-all-transactions'); const lPend = document.getElementById('list-pending'); const pendSec = document.getElementById('pending-section'); if(!lVar) return;
            lVar.innerHTML = ''; lPend.innerHTML = ''; let hasPending = false;
            const all = [...appData.variable.map((x,i)=>({...x, type:'exp', idx:i})), ...appData.incomes.map((x,i)=>({...x, type:'inc', idx:i}))];
            all.sort((a,b) => new Date(b.date) - new Date(a.date));
            all.forEach((item, index) => {
                const isExp = item.type === 'exp'; const dateArr = item.date.split('-'); const dateStr = `${dateArr[2]}/${dateArr[1]}`; const delayClass = `delay-${Math.min((index % 5) * 100, 300)}`;
                if(isExp && (!item.category || item.category === 'Sem Categoria')) { hasPending = true; lPend.innerHTML += `<li class="bg-yellow-50 p-2 rounded border border-yellow-200 flex justify-between items-center text-sm"><span class="font-bold text-yellow-800">${item.name} (${fmt(item.value)})</span> <button onclick="openEditCat(${item.idx})" class="bg-white border text-xs px-2 py-1 rounded">Classificar</button></li>`; }
                if(lVar.childElementCount < 50) { lVar.innerHTML += `<tr class="group hover:bg-slate-50 transition dark:hover:bg-slate-800 page-enter ${delayClass}"><td class="py-3 text-xs text-slate-400 font-medium border-b border-slate-50 dark:border-slate-800">${dateStr}</td><td class="py-3 font-bold text-slate-700 dark:text-slate-200 border-b border-slate-50 dark:border-slate-800">${item.name || item.description}</td><td class="py-3 border-b border-slate-50 dark:border-slate-800"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${isExp ? 'bg-slate-100 text-slate-500' : 'bg-green-100 text-green-600'}">${isExp ? (item.category||'Geral') : 'Entrada'}</span></td><td class="py-3 text-right font-bold ${isExp ? 'text-slate-800 dark:text-white' : 'text-green-500'} border-b border-slate-50 dark:border-slate-800">${isExp ? '-' : '+'} ${fmt(item.value)}</td><td class="py-3 text-right border-b border-slate-50 dark:border-slate-800"><button onclick="delItem('${item.type === 'exp' ? 'variable' : 'incomes'}', ${item.idx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button></td></tr>`; }
            });
            if(pendSec) pendSec.classList.toggle('hidden', !hasPending);
        }
        function renderGoalsList() { const el = document.getElementById('list-goals-full'); if(!el) return; el.innerHTML = ''; appData.goals.forEach((g, i) => { const saved = g.saved || 0; const pct = g.totalValue > 0 ? (saved / g.totalValue) * 100 : 0; el.innerHTML += `<div class="p-4 border rounded-xl bg-slate-50 dark:bg-slate-800 dark:border-slate-700 page-enter"><div class="flex justify-between font-bold mb-2"><span>${g.name}</span><span class="text-primary">${pct.toFixed(0)}%</span></div><div class="h-2 bg-slate-200 rounded-full mb-2"><div class="h-2 bg-primary rounded-full" style="width:${Math.min(pct,100)}%"></div></div><div class="flex justify-between text-xs text-slate-500"><span>${fmt(saved)} de ${fmt(g.totalValue)}</span><div class="flex gap-2"><button onclick="openAporte(${g.id})" class="text-primary font-bold hover:underline">Aportar</button><button onclick="delItem('goals',${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div></div></div>`; }); }
        function renderDebtsList() { const el = document.getElementById('list-debts'); if(!el) return; el.innerHTML = ''; appData.debts.forEach((d, i) => { el.innerHTML += `<div class="p-3 bg-white border-l-4 border-red-500 shadow-sm rounded flex justify-between items-center dark:bg-slate-800 page-enter"><div class="text-sm"><strong>${d.name}</strong><br><span class="text-xs text-slate-500">Total: ${fmt(d.totalValue)} (${d.installments}x)</span></div><button onclick="delItem('debts',${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>`; }); }
        function renderBudgetList() { const el = document.getElementById('budget-list'); if(!el) return; el.innerHTML = ''; const currMonth = new Date().getMonth(); appData.categories.forEach((cat, index) => { const b = appData.budgets.find(x => x.cat === cat); const lim = b ? b.lim : 0; const spent = appData.variable.filter(v => v.category === cat && new Date(v.date).getMonth() === currMonth).reduce((a,x)=>a+x.value,0); const pct = lim > 0 ? (spent/lim)*100 : 0; const color = pct > 100 ? 'bg-red-500' : (pct > 80 ? 'bg-yellow-500' : 'bg-primary'); el.innerHTML += `<div class="p-3 border rounded-xl bg-white dark:bg-slate-800 dark:border-slate-700 page-enter delay-${index%3}00"><div class="flex justify-between text-sm font-bold mb-1"><span>${cat}</span><span class="${pct>100?'text-red-500':'text-slate-500'}">${fmt(spent)} / <input type="number" value="${lim}" onchange="updateBudgetLimit('${cat}',this.value)" class="w-16 bg-transparent border-b text-right outline-none"></span></div><div class="h-2 bg-slate-100 rounded-full"><div class="h-2 rounded-full ${color} transition-all duration-1000" style="width:${Math.min(pct,100)}%"></div></div></div>`; }); }
        function renderFixedList() { const el = document.getElementById('list-fixed'); if(!el) return; el.innerHTML = ''; appData.fixed.forEach((f, i) => { el.innerHTML += `<tr class="border-b dark:border-slate-700 page-enter"><td class="p-3 font-medium">${f.name}</td><td class="p-3 text-right">${fmt(f.value)}</td><td class="p-3"><button onclick="delItem('fixed',${i})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        function renderCategoryManagementList() { const el = document.getElementById('category-list-manage'); if(!el) return; el.innerHTML = ''; appData.categories.forEach((c, i) => { el.innerHTML += `<li class="flex justify-between bg-slate-50 p-2 rounded border text-xs dark:bg-slate-800 dark:border-slate-700 page-enter"><span>${c}</span><button onclick="removeCategory(${i})" class="text-red-400 hover:text-red-600 transition hover:scale-110">x</button></li>`; }); }

        function renderCharts(mData) {
            if(document.getElementById('chart-balance')) { if(chartBal) chartBal.destroy(); chartBal = new Chart(document.getElementById('chart-balance'), { type: 'line', data: { labels: mData.map(d=>d.month), datasets: [{ label: 'Saldo', data: mData.map(d=>d.accumulated), borderColor: '#8D5AE4', backgroundColor: 'rgba(141, 90, 228, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {display: false}, y: {display: false} }, animation: { duration: 1500, easing: 'easeOutQuart' } } }); }
            if(document.getElementById('chart-pie-expenses')) { const cats = {}; appData.variable.forEach(v => { cats[v.category] = (cats[v.category]||0) + v.value; }); if(chartPie) chartPie.destroy(); chartPie = new Chart(document.getElementById('chart-pie-expenses'), { type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#8D5AE4', '#21E9CA', '#10b981', '#f59e0b', '#ef4444', '#8b5ae4'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } }, animation: { animateScale: true, animateRotate: true } } }); }
            if(document.getElementById('chart-expenses')) { if(chartExp) chartExp.destroy(); chartExp = new Chart(document.getElementById('chart-expenses'), { type: 'bar', data: { labels: mData.map(d=>d.month), datasets: [{ label: 'Receita', data: mData.map(d=>d.revenue), backgroundColor: '#10b981' }, { label: 'Despesa', data: mData.map(d=>d.expenses), backgroundColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: {stacked: true}, y: {stacked: true} }, animation: { duration: 1000 } } }); }
            const botCont = document.getElementById('bottleneck-chart-container'); const botCv = document.getElementById('chart-bottlenecks');
            if(botCont && botCv) { const over = {}; let hasOver = false; const currMonth = new Date().getMonth(); appData.categories.forEach(cat => { const b = appData.budgets.find(x => x.cat === cat); if(b && b.lim > 0) { const spent = appData.variable.filter(v => v.category === cat && new Date(v.date).getMonth() === currMonth).reduce((a,x)=>a+x.value,0); if(spent > b.lim) { over[cat] = spent - b.lim; hasOver = true; } } }); if(hasOver) { botCont.classList.remove('hidden'); if(chartBottle) chartBottle.destroy(); chartBottle = new Chart(botCv, { type: 'bar', data: { labels: Object.keys(over), datasets: [{ label: 'Excesso', data: Object.values(over), backgroundColor: '#ef4444' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false } }); } else { botCont.classList.add('hidden'); } }
        }

        function updateSelects() {
            const sels = ['var-cat', 'edit-cat']; sels.forEach(id => { const el = document.getElementById(id); if(el) { const old = el.value; el.innerHTML = appData.categories.map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="NEW">+ Nova...</option>`; if(old) el.value = old; } });
            const dl = document.getElementById('origins-list'); if(dl) { dl.innerHTML = ''; appData.incomeOrigins.forEach(o => dl.innerHTML += `<option value="${o}">`); }
        }

        window.nav = (id) => { const pages = document.querySelectorAll('[id^="page-"]'); pages.forEach(p => { p.classList.add('hidden'); p.classList.remove('page-enter'); }); const target = document.getElementById('page-'+id); if(target) { target.classList.remove('hidden'); void target.offsetWidth; target.classList.add('page-enter'); } document.querySelectorAll('.nav-link, .mob-nav-item').forEach(l => l.classList.remove('active')); const dLink = document.getElementById('nav-d-'+id); if(dLink) dLink.classList.add('active'); const mLink = document.getElementById('mob-'+id); if(mLink) mLink.classList.add('active'); const titles = { dashboard: 'Vis√£o Geral', launch: 'Lan√ßamentos', dre: 'Relat√≥rio DRE', budget: 'Or√ßamento', goals: 'Metas', debts: 'D√≠vidas', fixed: 'Custos Fixos' }; document.getElementById('page-title').innerText = titles[id] || 'Fycash'; if(id === 'dashboard' || id === 'launch') render(); if(id === 'dre') window.renderDRE(); };
        window.setLaunchMode = (m) => { document.getElementById('form-expense').classList.toggle('hidden', m !== 'expense'); document.getElementById('form-income').classList.toggle('hidden', m !== 'income'); document.getElementById('btn-mode-exp').className = m === 'expense' ? 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-slate-800 shadow-sm border border-slate-200 transform scale-105 border-brand-purple' : 'flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-50'; document.getElementById('btn-mode-inc').className = m === 'income' ? 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-slate-800 shadow-sm border border-slate-200 transform scale-105 border-brand-purple' : 'flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-50'; };
        
        // ... (window functions addVar, addIncome, etc. remain the same) ...
        window.addVar=async(e)=>{e.preventDefault();const desc=document.getElementById('var-desc').value;const val=parseFloat(document.getElementById('var-val').value);const cat=document.getElementById('var-cat').value;const date=document.getElementById('var-date').value;const parc=parseInt(document.getElementById('var-parc').value)||1;if(desc&&val){const valPerMonth=val/parc;const dObj=new Date(date);for(let i=0;i<parc;i++){const newD=new Date(dObj.getFullYear(),dObj.getMonth()+i,dObj.getDate()+1).toISOString().split('T')[0];appData.variable.push({name:desc+(parc>1?` (${i+1}/${parc})`:''),value:valPerMonth,category:cat,date:newD});}await saveData();e.target.reset();document.getElementById('var-date').valueAsDate=new Date();render();alert('Lan√ßamento salvo!');}};
        window.addIncome=async(e)=>{e.preventDefault();const desc=document.getElementById('inc-desc').value;const val=parseFloat(document.getElementById('inc-val').value);const date=document.getElementById('inc-date').value;const origin=document.getElementById('inc-origin').value;if(desc&&val){appData.incomes.push({description:desc,value:val,date:date,origin:origin});if(origin&&!appData.incomeOrigins.includes(origin))appData.incomeOrigins.push(origin);await saveData();e.target.reset();render();alert('Entrada salva!');}};
        window.addFixed=async(e)=>{e.preventDefault();const name=document.getElementById('fix-name').value;const val=parseFloat(document.getElementById('fix-val').value);if(name&&val){appData.fixed.push({name,value:val});await saveData();e.target.reset();render();}};
        window.addGoal=async(e)=>{e.preventDefault();const name=document.getElementById('goal-name').value;const val=parseFloat(document.getElementById('goal-val').value);const date=document.getElementById('goal-date').value;if(name&&val){appData.goals.push({id:Date.now(),name,totalValue:val,deadline:date,saved:0});await saveData();e.target.reset();render();}};
        window.addDebt=async(e)=>{e.preventDefault();const name=document.getElementById('debt-name').value;const tot=parseFloat(document.getElementById('debt-tot').value);const rate=parseFloat(document.getElementById('debt-rate').value)||0;const inst=parseInt(document.getElementById('debt-inst').value);if(name&&tot){const final=tot*(1+rate/100);appData.debts.push({name,totalValue:final,installments:inst,installmentValue:final/inst});await saveData();e.target.reset();render();}};
        window.delItem=async(type,idx)=>{if(confirm('Excluir este item?')){appData[type].splice(idx,1);await saveData();render();}};
        window.updateBudgetLimit=(cat,val)=>{const idx=appData.budgets.findIndex(b=>b.cat===cat);if(idx>-1)appData.budgets[idx].lim=parseFloat(val);else appData.budgets.push({cat,lim:parseFloat(val)});saveData();render();};
        
        // --- LOGIN HANDLER WITH FEEDBACK ---
        window.handleLogin = async () => {
            const btn = document.querySelector('button[onclick*="form-login-btn"]'); // Find the visual button that triggers this
            const originalText = btn ? btn.innerText : "Entrar";
            
            if (btn) {
                btn.innerText = "Entrando...";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            try {
                await signInWithEmailAndPassword(auth, document.getElementById('log-email').value, document.getElementById('log-pass').value);
            } catch(e) {
                alert("Erro ao logar: " + e.code);
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        };

        window.toggleAuth=(mode)=>{document.getElementById('view-login').classList.toggle('hidden',mode!=='login');};
        window.doLogout=()=>signOut(auth).then(()=>location.reload());
        
        window.forceOfflineMode = () => {
            isOffline = true;
            document.getElementById('auth-screen').classList.add('hidden');
            const appScreen = document.getElementById('app-screen');
            appScreen.classList.remove('hidden');
            appScreen.classList.add('flex');
            setTimeout(() => { appScreen.classList.remove('opacity-0'); }, 100);
            checkMigration();
            render();
        };

        window.handleCatChange = (el) => { if(el.value === 'NEW') { const n = prompt("Nova categoria:"); if(n) { appData.categories.push(n); updateSelects(); el.value = n; saveData(); } } };
        window.addNewCategory = () => { const n = document.getElementById('new-cat-input').value.trim(); if(n && !appData.categories.includes(n)) { appData.categories.push(n); saveData(); renderCategoryManagementList(); renderBudgetList(); updateSelects(); document.getElementById('new-cat-input').value = ''; } };
        window.removeCategory = (i) => { if(confirm("Remover categoria?")) { const categoryName = appData.categories[i]; appData.categories.splice(i,1); if(appData.budgets) { appData.budgets = appData.budgets.filter(b => b.cat !== categoryName); } saveData(); renderCategoryManagementList(); renderBudgetList(); updateSelects(); } };
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); render(); };
        window.openWhatsAppModal = () => document.getElementById('whatsapp-modal').classList.remove('hidden');
        window.closeWhatsAppModal = () => document.getElementById('whatsapp-modal').classList.add('hidden');
        window.sendAIMessage = async () => { const input = document.getElementById('ai-input-text'); const text = input.value.trim(); if (!text) return; const chatArea = document.getElementById('whatsapp-chat-area'); chatArea.innerHTML += `<div class="self-end bg-[#dcf8c6] p-2 rounded-lg rounded-tr-none shadow-sm text-sm max-w-[80%] mb-2">${text}<span class="text-[9px] text-slate-500 block text-right mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>`; input.value = ''; chatArea.scrollTop = chatArea.scrollHeight; const lower = text.toLowerCase(); let responseText = "Desculpe, n√£o entendi. Tente 'Gastei 50 em mercado' ou 'Recebi 1000'."; const spendMatch = lower.match(/(?:gastei|comprei|paguei)\s+(?:r\$)?\s*(\d+(?:[.,]\d{1,2})?)\s*(?:em|no|na|com)\s+(.+)/i); const incomeMatch = lower.match(/(?:recebi|ganhei)\s+(?:r\$)?\s*(\d+(?:[.,]\d{1,2})?)/i); if (spendMatch) { const val = parseFloat(spendMatch[1].replace(',', '.')); const desc = spendMatch[2].trim(); if (!isNaN(val)) { appData.variable.push({ name: desc, value: val, date: new Date().toISOString().split('T')[0], category: 'Sem Categoria', originalId: Date.now() }); await saveData(); render(); responseText = `‚úÖ Anotado: R$ ${fmt(val)} em "${desc}".`; } } else if (incomeMatch) { const val = parseFloat(incomeMatch[1].replace(',', '.')); if (!isNaN(val)) { appData.incomes.push({ description: 'Nova Entrada', value: val, date: new Date().toISOString().split('T')[0], origin: 'Outros', id: Date.now() }); await saveData(); render(); responseText = `üí∞ Boa! Adicionei uma receita de R$ ${fmt(val)}.`; } } setTimeout(() => { chatArea.innerHTML += `<div class="self-start bg-white p-2 rounded-lg rounded-tl-none shadow-sm text-sm max-w-[80%] mb-2">${responseText}<span class="text-[9px] text-slate-400 block text-right mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>`; chatArea.scrollTop = chatArea.scrollHeight; }, 600); };
        window.openEditCat = (idx) => { document.getElementById('edit-index').value = idx; document.getElementById('edit-name').value = appData.variable[idx].name; updateSelects(); document.getElementById('edit-cat').value = appData.variable[idx].category; document.getElementById('edit-modal').classList.remove('hidden'); };
        window.confirmEditCat = () => { const idx = document.getElementById('edit-index').value; appData.variable[idx].category = document.getElementById('edit-cat').value; saveData(); render(); document.getElementById('edit-modal').classList.add('hidden'); };
        window.prevGoal = () => { currentGoalIndex = Math.max(0, currentGoalIndex - 1); render(); };
        window.nextGoal = () => { currentGoalIndex = Math.min(appData.goals.length - 1, currentGoalIndex + 1); render(); };
        window.openAporte = (id) => { currentGoalId = id; document.getElementById('aporte-modal').classList.remove('hidden'); };
        window.confirmAporte = () => { const val = parseFloat(document.getElementById('aporte-val').value); if(currentGoalId && val) { const g = appData.goals.find(x => x.id === currentGoalId); if(g) { g.saved = (g.saved || 0) + val; saveData(); render(); } } document.getElementById('aporte-modal').classList.add('hidden'); };
        window.openArcaModal = () => { document.getElementById('arca-modal').classList.remove('hidden'); if(chartARCA) chartARCA.destroy(); const ctx = document.getElementById('chart-arca').getContext('2d'); chartARCA = new Chart(ctx, { type: 'bar', data: { labels: ['A√ß√µes','FIIs','Caixa','Ext'], datasets: [{label: 'Ideal', data:[25,25,25,25], borderColor:'#0ea5e9', type:'line'}, {label: 'Voc√™', data:[10,40,40,10], backgroundColor:'#6366f1'}] } }); };
        window.applyBudgetMethod = (type) => { const total = appData.incomes.reduce((a,b)=>a+b.value,0); if(total===0) return alert("Adicione receitas primeiro."); let budgets = []; if(type === 'PADRAO') { budgets = [ {cat:'Moradia', lim:total*0.3}, {cat:'Alimenta√ß√£o', lim:total*0.2}, {cat:'Lazer', lim:total*0.1}, {cat:'Investimentos', lim:total*0.3} ]; } else if(type === 'WAR') { budgets = [ {cat:'Moradia', lim:total*0.2}, {cat:'Alimenta√ß√£o', lim:total*0.1}, {cat:'Investimentos', lim:total*0.5} ]; } if(confirm("Aplicar or√ßamento?")) { budgets.forEach(b => { const idx = appData.budgets.findIndex(x=>x.cat===b.cat); if(idx>-1) appData.budgets[idx].lim = b.lim; else appData.budgets.push(b); }); saveData(); render(); } };
        window.simulateCompoundInterest = () => { const init = parseFloat(document.getElementById('comp-initial').value); const month = parseFloat(document.getElementById('comp-monthly').value); const rate = parseFloat(document.getElementById('comp-rate').value); const years = parseFloat(document.getElementById('comp-years').value); if(init && month && rate && years) { let total = init, invested = init; const months = years * 12; const mRate = rate / 100 / 12; const data = [], labels = []; for(let i=1; i<=months; i++) { total = (total + month) * (1 + mRate); invested += month; if(i%12===0) { labels.push(i/12); data.push(total); } } document.getElementById('comp-result-area').classList.remove('hidden'); document.getElementById('comp-result-total').innerText = fmt(total); document.getElementById('comp-result-invested').innerText = fmt(invested); document.getElementById('comp-result-interest').innerText = fmt(total-invested); if(compoundChart) compoundChart.destroy(); compoundChart = new Chart(document.getElementById('chart-compound'), { type: 'line', data: { labels, datasets: [{label: 'Evolu√ß√£o', data, borderColor: '#8b5ae4', fill: true}] } }); } };
        window.simulateDebtStrategy = (type) => { if(appData.debts.length === 0) return alert("Sem d√≠vidas."); let debts = [...appData.debts]; if(type === 'snowball') debts.sort((a,b) => a.totalValue - b.totalValue); else debts.sort((a,b) => b.totalValue - a.totalValue); let msg = type === 'snowball' ? "‚ùÑÔ∏è Bola de Neve (Pague as menores primeiro):\n" : "üèîÔ∏è Avalanche (Pague as maiores primeiro):\n"; debts.forEach((d,i) => msg += `${i+1}. ${d.name} (${fmt(d.totalValue)})\n`); alert(msg); };
        window.openFeedback = () => document.getElementById('feedback-modal').classList.remove('hidden');
        window.sendFeedback = async () => { const txt = document.getElementById('feedback-text').value; const type = document.getElementById('feedback-type').value; if(txt) { await addDoc(collection(db,'artifacts',appId,'global_feedback'), { text: txt, type, user: currentUser?.email, date: new Date().toISOString(), status: 'pending' }); alert("Feedback enviado!"); document.getElementById('feedback-modal').classList.add('hidden'); } };
        window.openAdmin = () => { document.getElementById('admin-modal').classList.remove('hidden'); loadAdmin(); };
        window.switchAdminTab = (t) => { currentAdminTab = t; loadAdmin(); };
        async function loadAdmin() { const el = document.getElementById('admin-list'); el.innerHTML = 'Carregando...'; const q = query(collection(db,'artifacts',appId,'global_feedback'), orderBy('date','desc')); const s = await getDocs(q); el.innerHTML = ''; s.forEach(doc => { const d = doc.data(); if(currentAdminTab === 'pending' && d.status === 'done') return; if(currentAdminTab === 'done' && d.status !== 'done') return; el.innerHTML += `<div class="bg-white p-3 mb-2 rounded border shadow-sm dark:bg-slate-700"><div><span class="font-bold text-xs uppercase bg-slate-200 px-2 py-1 rounded mr-2">${d.type}</span> <span class="font-bold">${d.user}</span></div><p class="text-sm mt-2">${d.text}</p>${d.status!=='done'?`<button onclick="solveFeedback('${doc.id}')" class="text-xs text-green-600 mt-2 font-bold">Resolver</button>`:''}</div>`; }); }
        window.solveFeedback = async (id) => { await updateDoc(doc(db,'artifacts',appId,'global_feedback',id), {status: 'done'}); loadAdmin(); };
        window.askAI = async (ctx) => { document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-content').innerText = "Pensando..."; try { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({contents:[{parts:[{text:`Analise dados financeiros (JSON): ${JSON.stringify(appData)}. Contexto: ${ctx}. Responda como consultor financeiro.`}]}]}) }); const d = await res.json(); document.getElementById('ai-content').innerHTML = marked.parse(d.candidates[0].content.parts[0].text); } catch(e) { document.getElementById('ai-content').innerText = "Erro na IA."; } };
        window.importCSV = (input) => { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const lines = e.target.result.split('\n'); let count = 0; lines.forEach(l => { const c = l.split(','); if(c.length >= 3) { const val = parseFloat(c[2]); if(!isNaN(val)) { appData.variable.push({ name: c[1] || 'Importado', value: Math.abs(val), date: c[0], category: 'Sem Categoria' }); count++; } } }); saveData(); render(); alert(`${count} itens importados.`); }; reader.readAsText(file); };
        window.renderDRE = () => { const mData = getMonthlyData(); const curr = mData[new Date().getMonth()]; const gross = curr.revenue; const currMonth = new Date().getMonth(); const varCosts = appData.variable.filter(v => v.category !== 'Investimentos' && new Date(v.date).getMonth() === currMonth).reduce((a,b)=>a+b.value,0); const contrib = gross - varCosts; const fixed = appData.fixed.reduce((a,b)=>a+b.value,0); const ebit = contrib - fixed; const invest = appData.variable.filter(v => v.category === 'Investimentos' && new Date(v.date).getMonth() === currMonth).reduce((a,b)=>a+b.value,0); const net = ebit - invest; const el = document.getElementById('dre-body'); if(el) { el.innerHTML = `<tr><td class="p-4 font-bold text-slate-700 dark:text-white">Receita Bruta</td><td class="p-4 text-right text-green-500 font-bold">+ ${fmt(gross)}</td><td class="p-4 text-right text-xs text-slate-400">100%</td></tr><tr><td class="p-4 pl-8 text-slate-500">(-) Despesas Vari√°veis</td><td class="p-4 text-right text-red-400">- ${fmt(varCosts)}</td><td class="p-4 text-right text-xs text-slate-400">${((varCosts/gross)*100).toFixed(1)}%</td></tr><tr class="bg-slate-50 font-bold dark:bg-slate-800"><td class="p-4 text-slate-800 dark:text-white">(=) Margem Contribui√ß√£o</td><td class="p-4 text-right text-slate-700 dark:text-white">${fmt(contrib)}</td><td class="p-4 text-right text-xs">--</td></tr><tr><td class="p-4 pl-8 text-slate-500">(-) Custos Fixos</td><td class="p-4 text-right text-red-400">- ${fmt(fixed)}</td><td class="p-4 text-right text-xs text-slate-400">--</td></tr><tr class="bg-slate-50 font-bold dark:bg-slate-800"><td class="p-4 text-slate-800 dark:text-white">(=) EBIT (Operacional)</td><td class="p-4 text-right text-slate-700 dark:text-white">${fmt(ebit)}</td><td class="p-4 text-right text-xs">--</td></tr><tr><td class="p-4 pl-8 text-slate-500">(-) Investimentos</td><td class="p-4 text-right text-purple-400">- ${fmt(invest)}</td><td class="p-4 text-right text-xs text-slate-400">--</td></tr><tr class="bg-slate-900 text-white font-bold"><td class="p-4">(=) Lucro L√≠quido</td><td class="p-4 text-right">${fmt(net)}</td><td class="p-4 text-right text-xs">--</td></tr>`; document.getElementById('dre-net-profit').innerText = fmt(net); if(chartDREComp) chartDREComp.destroy(); chartDREComp = new Chart(document.getElementById('chart-dre-comp'), { type: 'pie', data: { labels:['Var','Fixo','Invest','Lucro'], datasets:[{data:[varCosts,fixed,invest,Math.max(0,net)], backgroundColor:['#ef4444','#f59e0b','#6366f1','#10b981']}] }, options: {maintainAspectRatio:false} }); if(chartDRETrend) chartDRETrend.destroy(); const trends = mData.map(m => m.revenue - m.expenses); chartDRETrend = new Chart(document.getElementById('chart-dre-trend'), { type: 'line', data: { labels:mData.map(m=>m.month), datasets:[{label:'Lucro', data:trends, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', fill:true}] }, options: {maintainAspectRatio:false} }); } };

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    currentUser = user;
                    document.getElementById('auth-screen').classList.add('hidden');
                    const appScreen = document.getElementById('app-screen');
                    appScreen.classList.remove('hidden');
                    appScreen.classList.add('flex');
                    setTimeout(() => { appScreen.classList.remove('opacity-0'); }, 100);
                    // Check email existence
                    const displayEmail = user.email || "Convidado";
                    document.getElementById('user-name-display').innerText = displayEmail.includes('@') ? displayEmail.split('@')[0] : displayEmail;
                    if(user.email === ADMIN_EMAIL) document.getElementById('btn-admin').classList.remove('hidden');
                    const docRef = doc(db,'artifacts',appId,'users',user.uid,'app_data','main');
                    if(unsubscribeUser) unsubscribeUser();
                    unsubscribeUser = onSnapshot(docRef, (s) => {
                        if(s.exists()) { appData = s.data(); checkMigration(); }
                        else { appData = { incomes: [], fixed: [], variable: [], categories: [...DEFAULT_CATEGORIES], debts: [], goals: [], budgets: [], incomeOrigins: ['Sal√°rio'] }; saveData(); }
                        render();
                    }, (err) => { forceOfflineMode(); });
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-screen').classList.add('hidden');
                }
            });
        }
        document.getElementById('var-date').valueAsDate = new Date();
        document.getElementById('inc-date').valueAsDate = new Date();
    </script>
</body>
</html>
